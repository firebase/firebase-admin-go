name: Go Continuous Integration
on: [push, pull_request]
jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    env:
        GOPATH: /home/runner/work/firebase-admin-go/firebase-admin-go/go
    strategy:
      matrix:
        go: [1.11, 1.12, 1.13]
    steps:

    - name: Set up Go ${{ matrix.go }}
      uses: actions/setup-go@v1
      with:
        go-version: ${{ matrix.go }}
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      with:
        path: go/src/firebase.google.com/go
    
    - name: Get dependencies
      run: |
        echo "GOPATH = ${GOPATH}"
        go get -t -v $(go list ./... | grep -v integration)
        go get golang.org/x/lint/golint

    - name: Run Linter
      working-directory: ./go/src/firebase.google.com/go
      run: golint -set_exit_status $(go list ./...)

    - name: Run Unit Tests
      working-directory: ./go/src/firebase.google.com/go
      run: go test -v -race -test.short ./...

    - name: Run Formatter
      working-directory: ./go/src/firebase.google.com/go
      if: matrix.go != '1.11'
      run: |
        if [[ ! -z "$(gofmt -l -s .)" ]]; then
          echo "Go code is not formatted:"
          gofmt -d -s .
        fi 

    - name: Run Static Analyzer
      working-directory: ./go/src/firebase.google.com/go
      run: go vet -v ./...
